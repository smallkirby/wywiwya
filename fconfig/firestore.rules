rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{uid} {
      function isOwnPath(uid) {
        return uid == request.auth.uid
      }
      function isValidCreation(data) {
        return data.keys().hasAll(['uid', 'photoURL', 'displayName', 'numDiaries'])
        && data.keys().hasOnly(['uid', 'photoURL', 'displayName', 'numDiaries'])
        && data.uid is string && data.photoURL is string && data.displayName is string
        && data.numDiaries is number
        && data.uid == uid && data.numDiaries == 0
        ;
      }
      function isValidUpdate(data) {
        return data.keys().hasAll(['uid', 'photoURL', 'displayName', 'numDiaries'])
        && data.keys().hasOnly(['uid', 'photoURL', 'displayName', 'numDiaries'])
        && data.uid is string && data.photoURL is string && data.displayName is string
        && data.uid == uid
        && data.diff(resource.data).affectedKeys().hasOnly(['photoURL', 'displayName'])
        ;
      }
      allow create: if signedIn() && isOwnPath(uid) && isValidCreation(inData());
      allow delete: if false;
      allow update: if signedIn() && isOwnPath(uid) && isValidUpdate(inData());
      allow read: if signedIn() && isOwnPath(uid);
    }

    match /users/{uid}/diaries/{did} {
      function isOwnPath(uid) {
        return uid == request.auth.uid
      }
      function isValidUpdate(data) {
        return data.keys().hasAll(['dateID', 'createdAt', 'lastUpdatedAt', 'isPublic', 'isTemporary', 'contentMd', 'author', 'id'])
        && data.keys().hasOnly(['dateID', 'createdAt', 'lastUpdatedAt', 'isPublic', 'isTemporary', 'contentMd', 'author', 'id'])
        && data.diff(resource.data).affectedKeys().hasOnly(['lastUpdatedAt', 'isPublic', 'contentMd', 'isTemporary'])
        && data.lastUpdatedAt is timestamp
        && data.isPublic is bool
        && data.isTemporary is bool
        && data.contentMd is string
        && data.id is string && data.id == did
        ;
      }
      allow create: if false;
      allow delete: if false;
      allow update: if signedIn() && isOwnPath(uid) && isValidUpdate(inData());
      allow read: if signedIn() && isOwnPath(uid);
    }

    // collection group query of diaries
    match /{path=**}/diaries/{dID} {
      function isValidListing (data) {
        return data.isPublic == true;
      }

      allow list: if isValidListing(resource.data);
      allow get: if false;
      allow write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }

    function inData() {
      return request.resource.data;
    }

    function signedIn() {
      return request.auth.uid != null
    }
  }
}